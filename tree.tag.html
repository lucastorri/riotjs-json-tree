
<tree>

  <div class="tree-controls" if={ isRoot }>
    <a onclick={ toggleAll }>toggle</a>
    <a onclick={ resetAll }>reset</a>
  </div>
  
  <span if={ isObject } class="tree-node tree-node-object">
    &#123; <a onclick={ toggle }>{ show ? '-' : '+' }</a>
    <ul if={ show }>
      <li each={ element in Object.entries(obj) } >
        <span class="tree-key"><raw html={ renderKey(element[0]) } /></span>
        <tree parent={ this } obj={ element[1] } customizer={ customizer } show-depth={ props.showDepth - 1 } show-all={ showAll } path={ '.' + element[0] } />
      </li>
    </ul>
    &#125;
  </span>

  <span if={ isArray } class="tree-node tree-node-array">
    [
    <a onclick={ toggle }>{ show ? '-' : '+' }</a>
    <ul if={ show }>
      <li each={ (element, index) in obj }>
        <tree parent={ this } obj={ element } customizer={ customizer } show-depth={ props.showDepth - 1 } show-all={ showAll } path={ '[' + index + ']' } />
      </li>
    </ul>
    ]
  </span>

  <span if={ isLeaf } class="tree-leaf tree-leaf-{ type }"><raw html={ renderLeaf() } /></span>

  <script>
    riot.register('raw', {
      name: 'raw',
      template: '',
      exports: {
        updateHTML() {
          this.root.innerHTML = this.props.html;
        },
        onMounted() {
          this.updateHTML();
        },
        onUpdated() {
          this.updateHTML();
        },
      },
    });

    const defaultCustomizer = {
      key: (path, key, obj) => key,
      leaf: (path, obj) => JSON.stringify(obj),
    };

    export default {

      onBeforeMount() {
        this.isRoot = !this.props.parent;

        this.obj = this.props.obj;
        this.path = this.isRoot ? '' : this.props.parent.path + this.props.path;
        this.type = (() => {
          if (Array.isArray(this.obj)) return "array";
          else if (this.obj === null) return "null";
          else return typeof this.obj;
        })();

        this.isArray = this.type === "array";
        this.isObject = this.type === "object";
        this.isLeaf = !(this.isArray || this.isObject);

        this.customizer = (() => {
          const base = Object.assign({}, defaultCustomizer, this.props.customizer);
          return Object.fromEntries(Object.entries(base).map(([property, f]) => {
            const nf = (...args) => {
              const result = f(...args);
              return result === undefined ? defaultCustomizer[property](...args) : result;
            };
            return [property, nf];
          }));
        })();
      },

      onMounted() {
        this.resetAll();
      },

      onUpdated() {
        this.showAll = this.props.showAll || false;
        this.show = this.show || this.showAll;
      },
      
      toggle() {
        this.show = !this.show;
        this.showAll = false;
        this.update();
      },

      toggleAll() {
        this.showAll = !this.show;
        this.show = this.showAll;
        this.update()
      },

      resetAll() {
        this.show = false;
        this.update();
        this.showAll = this.props.showAll || false;
        this.show = this.props.showDepth > 0 || this.showAll;
        this.update();
      },
     
      root() {
        return this.isRoot ? this : this.parent.root();
      },

      renderKey(key) {
        return this.customizer.key(`${this.path}.${key}`, key, this.obj);
      },

      renderLeaf() {
        return this.customizer.leaf(this.path, this.obj, this.type);
      },

    }
  </script>

</tree>
